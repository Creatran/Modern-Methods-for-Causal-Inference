---
title: "R Lab 4:  IPTW & the Positivity Assumption"
subtitle: "Modern Methods for Causal Inference"
date: "Due June 17, 2020 at 11:59PM on Canvas"
output: 
  wcmtheme::wcm_html: 
    toc: true
    toc_float: true
    number_toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

> Goals: 1. Implement IPTW for a binary exposure. 2. Implement IPTW to estimate the coefficients corresponding to a marginal structural model (MSM). 3. Understand how the IPTW estimator is affected by "near" positivity violations and weight stabilization.  

# Background Story

Scurvy is a disease caused by lack of citrus (oranges, limes, etc.). It is common among sailors on long journeys. You have been hired to estimate the causal effect of scurvy on mortality among sailors.  The data available on $n$ sailors are:

- $W_1$: A binary covariate for whether the sailor has been on a long journey in the past, and is thus an "experienced sailor" (yes = `1`, no = `0`).

- $W_2$: a summary measure of route danger, including voyage length, hurricane season, travel through enemy waters, Bermuda triangle, etc. This is a categorical variable ranging from 0 as least dangerous to 3 as most dangerous.

- $A$: whether the sailor suffered from scurvy during the voyage. This is a binary exposure (yes = `1`, no = `0`).

- $Y$: sailor's mortality status. This is a binary outcome with 1 for deceased and 0 for alive. 


# Causal Road Map Review

**Step 1: Specify the Question:**

What is the causal effect of scurvy on mortality among sailors?

**Step 2: Specify the causal model:**

- Endogenous nodes: $X= (W_1, W_2, A, Y)$, where $W_1$ is an indicator for whether the ship stocks oranges, $W_2$ is a summary measure of route danger, $A$ is scurvy status, and $Y$ is mortality.

- Exogenous nodes: $U = (U_{W_1},U_{W_2}, U_A, U_Y) \sim \mathrm{P}^*$. We make no assumptions about the distribution $\mathrm{P}^*$.

- Structural equations ${F}$:  \begin{align*}
W_1 & \leftarrow f_{W_1}(U_{W_1}) \\
W_2 & \leftarrow f_{W_2}(W_1, U_{W_2}) \\
A & \leftarrow f_A(W_1,W_2, U_A) \\
Y & \leftarrow f_Y(W_1,W_2, A, U_Y) \end{align*}
There are no exclusion restrictions or assumptions about functional form. 

**Step 3: Specify the causal parameter of interest:**

We are interested in the causal risk of death due to scurvy (i.e. the average treatment effect): \[
\theta^* = \mathrm{E}^*(Y_1) - \mathrm{E}^*(Y_0)  = \mathrm{P}^*(Y_1=1) - \mathrm{P}^*(Y_0=1)
\]
where $Y_a$ denotes the counterfactual outcome (mortality), if possibly contrary to fact, the sailor had scurvy status $A=a$.

**Step 4: specify the link between the SCM and the observed data:**

The observed data were generated by sampling $n$ independent times  from a data generating system compatible with the structural causal model. This yield $n$ i.i.d. copies of random variable $O=(W_1,W_2,A, Y) \sim \mathrm{P}$.  The statistical model for the set of allowed distributions of the observed data is non-parametric.

**Step 5: Assess identifiability:**

In the original SCM, the target causal parameter is not identified from the observed data distribution. A sufficient, but not minimal, identifiability assumption is that all of the background factors are independent.  Other possibilities include $U_A \perp U_Y$ and (i) $U_A \perp U_{W_1}$, $U_A \perp U_{W_2}$ or (ii) $U_Y \perp U_{W_1}$, $U_Y \perp U_{W_2}$. Under any of the above identifying assumptions, the backdoor criteria holds conditionally on $W=(W_1,W_2)$.

For identifiability, we also need the positivity assumption to hold: \[
min_{a\in \mathcal{A}} \ \mathrm{P}(A=a |W=w)  >0
\]
for all $w$ for which $\mathrm{P}(W=w) >0$. In words, we need that each possible exposure level is represented in every covariate strata.  This condition on data support ensures that our statistical estimand is well-defined.  

In our example, there must be a positive probability of having scurvy or not, within strata of "experienced sailor" status and route danger. Here, we are using $W=(W_1,W_2)$ to denote the set of covariates that satisfy the backdoor criteria under the working SCM.


**Step 6: Specify the target parameter of the observed data distribution:**

Our target statistical parameter is given by  the G-Computation formula:
\begin{align*}
\theta &= \mathrm{E} \big[ \mathrm{E}(Y|A=1, W) - \mathrm{E}(Y|A=0, W) \big] \\
  &= \sum_{w} \big[ \mathrm{E}(Y|A=1, W=w) - \mathrm{E}(Y|A=0,W=w) \big] \mathrm{P}(W=w)
\end{align*}
where $W=(W_1,W_2)$. This can equivalently be expressed as the IPW estimand:
\begin{align*}
\theta &=  \mathrm{E} \left[ \left(\frac{\mathrm{I}(A=1)}{\mathrm{P}(A|W)} - \frac{\mathrm{I}(A=0)}{\mathrm{P}(A|W)} \right) Y \right]
\end{align*}

**Step 7: Estimate the chosen parameter of the observed data distribution:**

We have discussed two estimators of the statistical parameter. They rely on estimating different parts of the observed data distribution $\mathrm{P}$:

a) Simple substitution estimator based on the G-Computation formula: \[
\hat{\theta}_{G-comp} = \frac{1}{n} \sum_{i=1}^n \left[\hat{\mathrm{E}}(Y_i |A_i=1, W_i) - \hat{\mathrm{E}}(Y_i |A_i=0, W_i)\right]
\]
where $\hat{\mathrm{E}}(Y |A, W)$ is the estimate of the conditional mean outcome given the exposure (scurvy) and baseline covariates $\mathrm{E}(Y|A,W)$.

b) **Inverse probability weighted estimator (IPTW)**: \[
\hat{\theta}_{IPTW} = \frac{1}{n}\sum_{i=1}^n \left(\frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i)} - \frac{\mathrm{I}(A_i=0)}{\hat{\mathrm{P}}(A_i|W_i)} \right) Y_i
\]
where $\hat{\mathrm{P}}(A_i|W_i)$ is an estimate of the conditional probability of scurvy given the baseline characteristics $\mathrm{P}(A|W)$. This conditional distribution is often referred to as the exposure or treatment mechanism. IPTW is the focus of today's lab.

c) TMLE: Coming soon.

**Step 8: Inference and interpret results:** Coming soon.


# Import and explore data 

**0. Import `Lab4_IPTW.csv` and call it `ObsData`.**

**1. Use the `nrow` function to count the number of sailors in the data set. Assign this number as `n`.**

**2. Using the `table` or a similar function, check the number of sailors in each covariate strata  without scurvy $A=0$ and the number of sailors in each covariate strata with scurvy $A=1$.** *Note: these tables are simply counting the number of observations within each strata of $(W_1,W_2,A)$ in a single sample of size $n$; we are not formally evaluating the positivity assumption, which is a statistical assumption on the true data generating process $\mathrm{P}$.*


# Implement the IPTW for a binary exposure

**3. Estimate the treatment mechanism $\mathrm{P}(A|W)$, which is the conditional probability of scurvy, given the sailor's characteristics.** Use the following *a priori*-specified parametric regression model: \[
\mathrm{P}(A=1|W) = expit\big[ \beta_0 + \beta_1 W_1 + \beta_2 W_2  \big]
\]
*Hint:* Run `glm` with specifications `family='binomial'` for logistic regression and `data=ObsData`.

In practice, we would generally use a data-adaptive estimator, such as Super Learner.  To save time during lab, we are using the correctly specified parametric regression.

**4. Predict each sailor's probability of his observed exposure (scurvy status), given his covariates: $\hat{\mathrm{P}}(A_i|W_i)$}.**

  a) Obtain the predicted probability of having scurvy, given the baseline covariates `prob_1W`. *Hint:* Apply the `predict` function to the above fitted logistic regression function with `type='response'`.
  
  b) Obtain the predicted probability of not having scurvy, given the baseline covariates `prob_0W`: \[
  \hat{\mathrm{P}}(A=0|W) = 1 - \hat{\mathrm{P}}(A=1|W)  \]
  
  c) Create an empty vector `prob_AW` of length $n$.
  
  d) Among sailors with scurvy, assign the appropriate predicted probability:
  
```{r, eval=F}
prob_AW[ObsData$A==1] <- prob_1W[ObsData$A==1]
```
  
  e) Among sailors without scurvy, assign the appropriate predicted probability:
  
```{r, eval=F}
prob_AW[ObsData$A==0] <- prob_0W[ObsData$A==0]
```
  
  f) Use the`summary` function to examine the distribution of the predicted probabilities. Is there cause for concern?

**5. Create a vector `wt` as the inverse of the predicted probabilities. Use the `summary` function to examine the distribution of the weights.**

**6. Evaluate the IPTW estimand by taking the empirical mean of the weighted outcomes:** \[
\hat{\theta}_{IPTW} = \frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i)}Y_i - \frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=0)}{\hat{\mathrm{P}}(A_i|W_i)}Y_i
\]

**7. Comment on the results.**

**8. Arbitrarily truncate the weights at 10 and evaluate the IPTW estimand.** *Hint:* The following code copies the weight vector (`wt`) into a new vector (`wt_trunc`) and truncates the weights at 10.

```{r,eval=F}
wt_trunc<- wt
wt_trunc[wt_trunc > 10]<- 10
```

**9. Implement the stabilized IPTW estimator:**
\begin{align*}
\hat{\theta}_{Stab.IPTW} &= \frac{\frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i)}Y_i}{\frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i) } }  - \frac{\frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=0)}{\hat{\mathrm{P}}(A_i|W_i)}Y_i}{\frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=0)}{\hat{\mathrm{P}}(A_i|W_i)}}
\end{align*}

Dividing by the mean of the weights ensures that the IPTW estimator is bounded.



# IPTW & Marginal Structural Models 

*Recall:* Marginal structural models (MSMs) are just another way to define the target parameter. Specifically, they provide a summary measure of how the expected counterfactual outcome $Y_a$ changes as a function of treatment $A$ and possibly effect modifiers of interest, denoted $V$.

Suppose you are now interested in how the expected counterfactual mortality $Y_a$ varies as function of scurvy $A$ and route danger $V=W_2$. Specifically, she believes that the effect of scurvy on death is modified by the route danger.  Consider the following MSM to summarize how the counterfactual risk of mortality $Y_a$ varies of as a function scurvy $A$ and route danger $V$:  \begin{align*}
%\beta(\mathrm{P}^* | m ) &= argmin_{\beta} \mathrm{E}_{\mathrm{P}^*} \left[\sum_a -log\big[ m(a,V|\beta)^{Y_a}(1-m(a,V|\beta)) \big]^{1-Y_a}\right] \\
\mathrm{E}^*(Y_a |V ) = m(a, V | \beta) &=expit\big[ \beta_0 + \beta_1 a + \beta_2 V + \beta_3 a^*V \big]
\end{align*}
For simplicity, we are treating this MSM as the truth. In class, we covered estimation of parameters of *working* MSMs using IPTW with and without stabilized weights. This is Step 2 of the Causal Roadmap: specifying the question.

## Implement IPTW for the MSM parameter without stabilized weights:

- **Step 1: Estimate the treatment mechanism $\mathrm{P}(A|W)$, which is the conditional probability of scurvy, given the sailor's characteristics.**
*We already did this, so we will skip to next step.*

- **Step 1: Predict each sailor's probability of his observed exposure (scurvy status), given his covariates `prob.AW`.**
*We already did this, so we will skip to next step.*

- **Step 3: Create the weight vector `wt` as the inverse of the predicted probabilities:** \[
wt_i = \frac{1}{\hat{\mathrm{P}}(A_i|W_i)}
\]
*We already did this, so we will skip to next step.*

- **Step 4: Estimate the $\beta$ coefficients by regressing the outcome $Y$ on the exposure $A$ and effect modifier $V=W_2$ according to $m(a,V| \beta)$.**

**9. To complete step 4, sse `glm` to run a logistic regression.** Specify the `weights`, the `family` and the `data`.

**10. Interpret the IPTW MSM results.**

## Weight stabilization in IPTW for an MSM parameter

For  MSMs with effect modifiers $m(a,V|\beta)$, the numerator of the weights can be any function of the exposure $A$ and the effect modifier $V$. A common choice is the conditional probability of the observed exposure, given the effect modifier: \[
stab.wt_i  = \frac{\hat{\mathrm{P}}(A_i|V_i)}{\hat{\mathrm{P}}(A_i|W_i)}
\]
This can help reduce variability in the weights. If the covariates in $W$  no longer predict the exposure (whether a sailor has scurvy) after controlling  for the effect modifier (route's danger), then the weights will be 1. All the control for confounding is taken care of by adjustment for $V=W_2$ in the MSM. In less extreme cases, this choice of numerator can still increase efficiency. Sailors will get weighted based on the conditional probability of their observed exposure given the effect modifier $\hat{\mathrm{P}}(A_i|V_i)$ relative to the conditional probability of their observed exposure given all the confounders $\hat{\mathrm{P}}(A_i|W_i)$.

The  positivity assumption for a parameter defined with MSM $m(a,V|\beta)$ is also weakened: $$
sup_{a \in \mathcal{A}}    \frac{\mathrm{P}(a|v)}{\mathrm{P}(a|w)} < \infty \text{ for all } w  \text{ for which } \mathrm{P}(W=w)> 0 $$
For any $(a,V)$ combinations that occur with a non-zero probability, we need that the conditional probability of that exposure $a$ given the confounders $W$ to  also be non-zero.

## Implement IPTW for a MSM parameter with stabilized weights:

- **Step 1: Estimate the treatment mechanism $\mathrm{P}(A|W)$.** *We already did this, so we will skip to next step.*

- **Step 2: Predict each sailor's probability of his observed exposure (scurvy status), given his covariates `prob_AW`.**
*We already did this, so we will skip to next step.*

- **Step 3: Create the stabilized weights `wt_MSM`:** \[
stab.wt_i = \frac{\hat{\mathrm{P}}(A_i|V_i)}{\hat{\mathrm{P}}(A_i|W_i)}
\]

  **11. To complete Step 3, implement the following:**

  a. Estimate the conditional probability of the scurvy, given route danger $\mathrm{P}(A=1|V)$ with a saturated logistic regression:

```{r, eval=F}
prob_AV_reg <- glm(A ~ as.factor(W2), family="binomial", data=ObsData)
```

Note we are using the `as.factor` function to  create dummy variables for each level of route danger $W_2$.

  b. Obtain the predicted probability of having scurvy, given the route danger: `prob_1V`. 
*Hint:* Apply the `predict` function to the above fitted logistic regression function with `type='response'`.

  c. Calculate the predicted probability of not having scurvy, given the route danger: `prob_0V`: \[
\hat{\mathrm{P}}(0|V) = 1- \hat{\mathrm{P}}(1|V)
\]

  d. Create an empty vector `prob_AV` of length $n$.

  e. Among sailors with scurvy, assign the appropriate predicted probability:

```{r, eval=F}
prob_AV[ObsData$A==1] <- prob_1V[ObsData$A==1]
```

  f. Among sailors without scurvy, assign the appropriate predicted probability:
```{r, eval=F}
prob_AV[ObsData$A==0] <- prob_0V[ObsData$A==0]
```

  g. Create the stabilized weights:

```{r, eval=F}
wt_MSM<- prob_AV/prob_AW
```

  h. Discuss the distribution of the stabilized weights.

- **Step 4: Estimate the parameters of the MSM by regressing the observed outcome $Y$ on the exposure $A$ and effect modifier $V$ according to $m(a,V|\beta)$.**

  **12. To complete step 4, specify the `weights`, the `family`, and the `data` in a `glm()`.**

  **13. Comment on the resulting estimates.**


# Appendix A: a specific data generating process

The following code was used to generate the data set `Lab4_IPTW.csv`. In this data generating process (one of many compatible with the  SCM ), all exogenous errors are independent.

```{r, eval=F}
#-------
# genData: function to generate the data
# input: sample size n
# output: data frame with W1, W_2, A, Y, as well as counterfactuals Y_1 & Y_0
#-------
genData<- function(n){
  W1 <- rbinom(n, size=1, prob=.5) # characteristics
  W2 <- rbinom(n, size=3, prob=.5) # route safety from 0(safe)- 3 (dangerous)
  A <- rbinom(n, size =1, prob=plogis(-1.3 - 3*W1 +3*W2))
  Y<- rbinom(n, size=1, prob= plogis(-2 - 2*W1 +3*W2 +3*A+ 2*A*W2 ))
  Y_1<- rbinom(n, size=1, prob= plogis(-2 - 2*W1 +3*W2 +3*1+ 2*1*W2 ))
  Y_0<- rbinom(n, size=1, prob= plogis(-2 - 2*W1 +3*W2 +3*0+ 2*0*W2 ))
  data.frame(W1,W2, A, Y, Y_1,Y_0)
}
# create the RLab3_IPTW.csv
set.seed(252)
Full<- genData(n=5000)
ObsData<- subset(Full, select=c(W1,W2,A,Y))
write.csv(ObsData, file="Lab4_IPTW.csv", row.names=F)
```

$\bullet$ Given this specific data generating process, we could estimate the true value of the average treatment effect by drawing a huge number of observations and taking the mean difference in the counterfactual outcomes.

```{r, eval=F}
set.seed(252)
# calculate true ATE by drawing a huge number of observations
nTot=100000
Full <- genData(n=nTot)
theta_star <- mean(Full$Y_1)- mean(Full$Y_0)
theta_star
```

The counterfactual risk of mortality would $\theta^*(\mathrm{P}^*)$=26.4\% higher if all sailors had scurvy than if all sailors did not have scurvy.

$\bullet$ Now consider again the  MSM to summarize how the average counterfactual outcome mortality ($Y_a$) varies of as a function scurvy $(A)$ and route danger ($V$):  \begin{align*}
%\beta(\mathrm{P}^* | m ) &= argmin_{\beta} \mathrm{E}_{\mathrm{P}^*} \left[\sum_a -log\big[ m(a,V|\beta)^{Y_a}(1-m(a,V|\beta)) \big]^{1-Y_a}\right] \\
\mathrm{E}^*(Y_a |V ) = m(a, V | \beta) &=expit\big[ \beta + \beta_1 a + \beta_2 V + \beta_3 a^*V \big]
\end{align*}

Given the above data generating process, we could calculate the value of the target causal parameter, which  is the vector of coefficients $\beta$ that summarize how the counterfactual outcome changes as a function of the exposure and effect modifier, by regressing the counterfactual outcomes $Y_a$ on $A$ and $V$ according to the MSM.

```{r, eval=F}
# calculate true parameters of MSM
# recall the Full data set consist of (W1,W2,A, Y, Y_1, Y_0) on 100,000 sailors
Y_A<- c(Full$Y_1, Full$Y_0) # create a vector of the stacked counterfactuals
A <- c(rep(1, nTot), rep(0, nTot)) # the corresponding exposure levels
V <- rep(Full$W2, 2) # effect modifier repeated twice
true_MSM <- glm(Y_A~ A*V, family="binomial") #regress according to MSM
true_MSM$coef
```

The true parameters (coefficients) of the MSM are
 \[
\mathrm{E}^*(Y_a|V) = m(a, V| \beta) = expit[ -2.60 + 2.62^*a + 2.60^*V +1.94^*a^*V]
\]
This suggests that route danger $V=W_2$ does, indeed, modify the effect of scurvy $A$ on counterfactual mortality $Y_a$: \begin{align*}
logit[m(a, V=0| \beta)] &=  -2.60 + 2.62^*a + 2.60^*0 +1.94^*a^*0 = -2.60 + 2.62^*a \\
logit[m(a, V=1| \beta)] &=  -2.60 + 2.62^*a + 2.60^*1 +1.94^*a^*1 = 4.56^*a  \\
logit[m(a, V=2| \beta)] &= -2.60 + 2.62^*a + 2.60^*2 +1.94^*a^*2 = 2.60 + 6.38^*a \\
logit[m(a, V=3| \beta)] &= -2.60 + 2.62^*a + 2.60^*3 +1.94^*a^*3 = 5.2 + 9.92^*a
\end{align*}
Because we are assuming our MSM represents real knowledge about the form of $\mathrm{E}^*[Y_a|V]$ (rather than a projection of the truth onto a working model), we may interpret the coefficients as in classical  logistic regression:

- In the lowest level of route danger ($V=0$), the counterfactual odds of mortality would be $e^{2.62}= 13.74$ times higher if all sailors had scurvy than if no sailors had scurvy.

- In the first level of route danger ($V=1$), the counterfactual odds of mortality would be $e^{4.56}/e^{0}= 95.56$ times higher if all sailor had scurvy than if no sailors had scurvy.

- In the second level of route danger ($V=2$), the counterfactual odds of mortality would be $e^{6.38}= 589.93$ times higher if all sailor had scurvy than if no sailors had scurvy.

- In the highest level of route danger ($V=3$), the counterfactual odds of mortality would be $e^{9.92}= 20,332.99$ times higher if all sailor had scurvy than if no sailors had scurvy.

Conclusion: sailors need their vitamin C!


$\bullet$ If the MSM is considered a "working" model, then the choice of the numerator of the weights changes the projection. For example, if we set the numerator to be 1, then all areas of the causal curve are weighted equally. If, instead, we set the numerator to be the conditional probability of the exposure (scurvy), given the effect modifier (route danger) $\mathrm{P}(A_i|V_i)$, then we would be giving more weight to areas with better support.

```{r, eval=F}
# the true value of the MSM parameter with stabilized weights is calculated as follows
# recall the Full data consists (W1, W2, A, Y, Y_1, Y_0) for 100,000 sailors
#
# calculate the numerator
prob_AV_reg_true<- glm(A~ as.factor(W2), family="binomial", data=Full)
prob_1V_true<- predict(prob_AV_reg_true, type="response")
prob_0V_true<- 1- prob_1V_true
wt_st<- c(prob_1V_true, prob_0V_true) # corresponding to counterfactual exposure
# weighted regression
true_MSM_st<- glm(Y_A~ A*V, weights=wt_st ,family="binomial")
true_MSM_st$coef
```

