---
title: "R HW 4"
subtitle: "Modern Methods for Causal Inference"
date: "Due June 17, 2020 at 11:59PM on Canvas"
output: 
  wcmtheme::wcm_html: 
    toc: true
    toc_float: true
    number_toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Background and Causal Roadmap

**"Russian Health Campaign Allows Train Users In Moscow To Pay In Squats"**
*"Want a free journey on the Tube in Moscow? Drop down and give 30 squats. In an effort to promote the upcoming Winter Olympic games in Sochi, Moscow city officials and the Russian Olympic Committee are allowing subway riders to sweat it out to get to work. Instead of paying the regular 30 rubles (57p), commuters can now perform 30 squats at Vystavochnaya station..."* --[The Huffington Post UK](http://www.huffingtonpost.co.uk/2013/11/12/russia-moscow-train-squats_n_4260746.html)

Consider a hypothetical intervention by the MTA system, where riders will be given discounted subway tickets based on the number of pull-ups they can properly complete. For simplicity assume the minimum is 1 pull-up and maximum is 7 pull-ups. The goal is to estimate the effect of pull-ups performed on rider's happiness, which is measured on a validated scale from 30-45. We have data on the the following variables:

- $W_1$: lifestyle with 1 as very active, 2 as somewhat active, and 3 as sedentary

- $W_2$: sex with 1 as female and 0 as male

- $A$: number of pull-ups completed with 1 as the minimum and 7 as the maximum

- $Y$: happiness which is  a continuous scale from 30-45

![DAG corresponding to the study of pull-ups and happiness among MTA riders.](dag_rhw3.png)

## Causal Roadmap Rundown

This is a very quick summary for review. Each step of the roadmap requires careful thought and consideration.

### Step 1: Specify the Question:

What is the causal effect of pull-ups completed on happiness among MTA riders?


### Step 2: Specify the causal model:

- Endogenous nodes: $X= (W_1, W_2, A, Y)$, where $W_1$ is lifestyle, $W_2$ is sex, $A$ is number of pull-ups completed, and $Y$ is measured happiness. 

- Exogenous nodes: $U = (U_{W_1}, U_{W_2}, U_A, U_Y) \sim \mathrm{P}^*$. There are no independence assumptions.

- Structural equations $F$: \begin{align*}
W_1 & \leftarrow f_{W_1}(U_{W_1}) \\
W_2 &  \leftarrow f_{W_2}(U_{W_2}) \\
A &  \leftarrow f_A(W_1, W_2, U_A) \\
Y &  \leftarrow f_Y(W_1,W_2, A, U_Y) \end{align*}
Exclusion restrictions: we are assuming that the baseline covariates do not affect each other. We have not specified any functional forms.

### Step 3: Specify the causal parameter:

The exposure (pull-ups completed) has seven possible levels:\[
\mathcal{A}= \{1,2,3,4,5,6,7\}
\]
Therefore, we could consider defining the target causal parameter in terms of all pairwise differences of interest: \[
\theta^*(\mathrm{P}^*) = \mathrm{E}^*(Y_a) - \mathrm{E}^*(Y_{a'})
\]
where $Y_a$ is the counterfactual outcome (happiness), if possibly contrary to fact, the rider completed $A=a$ pull-ups. Here, $\theta^*(\mathrm{P}^*)$ is the difference in the expected counterfactual happiness if all riders completed $A=a$ pull-ups versus if all riders completed $A=a'$ pull-ups.

Alternatively, we could also consider a marginal structural model (MSM) to summarize how the counterfactual mean happiness $\mathrm{E}^*(Y_a)$ changes as a function pull-ups completed $a$. Consider, for example, \[
\mathrm{E}^*(Y_a) = m(a | \beta) = \beta_0 + \beta_1 a
\]
with $a \in \{1,2,3,4,5,6,7\}$. This specification  assumes a linear change in the expected counterfactual happiness with pull-ups completed. Alternatively, we can consider this a working MSM and define the parameter as the projection of the true causal curve onto this linear model: \[
\beta^* \equiv argmin_{\beta} \ \mathrm{E}^*\left[ \sum_{a\in \mathcal{A}}(Y_a - m(a| \beta) )^2 \mathrm{P}(A=a) \right]
\]


### Step 4: Specify the link between the SCM and the observed data:

The statistical model $\mathcal{M}$ for the set of allowed observed data distributions is non-parametric. The observed data were generated by sampling $n$ independent times from a data generating system described by the structural causal model. This yields $n$ i.i.d. copies of random variable $O=(W_1,W_2,A,Y) \sim \mathrm{P}$.  

### Step 5: Assess identifiability:

In the original SCM, the target causal parameter is not identified from the observed data distribution. A sufficient, but not minimal, assumption is that all of the unmeasured factors are independent. Other possibilities include $U_A \perp U_Y$ AND (i) $U_A \perp U_{W_1}$, $U_A \perp U_{W_2}$ OR (ii) $U_Y \perp U_{W_1}$, $U_Y \perp U_{W_2}$.
We require the backdoor criteria to hold for identifiability, and the set of baseline covariates $W=(W_1, W_2)$ conditionally satisfies the backdoor criteria.

To identify $\mathrm{E}^*(Y_a)$ (the expected counterfactual happiness under a given pull-up level) for all levels $\mathcal{A}$, we also need the positivity assumption to hold \[
min_{a\in \mathcal{A}}\  \mathrm{P}(A=a |W_1=w_1, W_2=w_2)  >0
\]
for all $(w_1, w_2)$ for which $\mathrm{P}(W_1=w_1, W_2=w_2) >0$. In terms of our example, there must be a positive probability of each exposure (number of completed pull-ups) within strata of lifestyle and sex. As detailed below, the positivity assumption needed for MSM parameters depends on the choice of the weight function $g^*(A)$.

### Step 6: Specify the statistical estimand:

Our statistical estimand is the G-Computation formula: \[
\theta(\mathrm{P}) = \mathrm{E} \big[ \mathrm{E}(Y|A=a, W) - \mathrm{E}(Y|A=a',W) \big] \]
where $W=(W_1, W_2)$ is the vector of baseline confounders. This can equivalently be expressed as the IPW estimand:
\begin{align*}
\theta(\mathrm{P}) &=  \mathrm{E} \left[ \left(\frac{\mathrm{I}(A=a)}{\mathrm{P}(A=a|W)} - \frac{\mathrm{I}(A=a')}{\mathrm{P}(A=a'|W)} \right) Y \right]
\end{align*}

For the target causal parameter defined with a working MSM, the statistical parameter is the solution in $\beta$ to the projection of the conditional mean outcome of the observed outcome $\mathrm{E}(Y|A=a,W)$ onto the MSM $m(a | \beta)$.

# Import and explore data 

**0. Import `HW3_IPTW.csv` and assign it to object `ObsData`.**

**1. Assign the number of riders to `n`.**

**2. Use the  `summary` function to explore the data.**

**3. Are there certain covariate combinations with limited variability in the exposure (pull-ups completed)?** Check the number of riders in each exposure-covariate category. *Note:* We are just counting the number of observations in a single sample of size $n$ - not formally evaluating the positivity assumption, which is an assumption on the true data generating process $\mathrm{P}$. **Comment on your findings.**

# IPTW for two levels of the exposure

Suppose we are interested in the difference in the expected happiness if all riders completed 7 pull-ups  ($A=7$) and if all riders only completed 1 pull-up ($A=1$): \[
\theta^*(\mathrm{P}^*) = \mathrm{E}^*(Y_7) - \mathrm{E}^*(Y_1)
\]

**4. We need to estimate the treatment mechanism $\mathrm{P}(A|W)$, which is the conditional probability of completing $A$ pull-ups, given the rider's characteristics.** Implement the following code to estimate the treatment mechanism with multinomial logistic regression via the `nnet` package.

```{r, eval=F}
library("nnet")
prob_AW_reg <- multinom(A ~ W1 + W2, data=ObsData)
```

**5. Predict each rider's probability of his/her observed exposure (pull-ups completed), given his/her covariates $\hat{\mathrm{P}}(A_i|W_i)$:**
  
  a) Use the `predict` function to obtain the predicted probability of each exposure level, given the rider's covariates. Be sure to specify `type="probs"`.

```{r, eval=F}
prob_AW_pred_matrix<- predict(prob_AW_reg, type="probs")
```

  This returns a matrix with rows as the participants and columns as their predicted probability of each exposure level, given the confounders.

   b) Create an empty vector `prob_AW` of length $n$ for the predicted probabilities of each rider's observed exposure (pull-ups completed), given their covariates.
   
  c) Among riders with exposure level $A=1$, assign the appropriate predicted probability:
  
```{r, eval=F}
prob_AW[ObsData$A==1] <- prob_AW_pred_matrix[ObsData$A==1, "1"]
```

  d) Implement the analogous code for exposure levels $A=2, \dots, A=7$.
  
  e) Use the `summary` function to examine the distribution of predicted probabilities. Is there any cause for concern?

**6. Create the  vector `wt` as the inverse of the predicted probabilities. Use the `summary` function to examine the distribution of weights. Comment on the distribution of weights.**

**7. Evaluate the IPTW estimand:**
\[
\hat{\theta}_{IPTW} = \frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=7)}{\hat{\mathrm{P}}(A_i|W_i)}Y_i - \frac{1}{n}\sum_{i=1}^n \frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i)}Y_i
\]
The first quantity is the weighted mean outcome, where riders completing $A_i=7$ pull-ups receive weight $1/\hat{\mathrm{P}}(A_i=7|W_i)$ and riders completing  $A_i \ne 7$ pull-ups receive weight 0. The second quantity is the weighted mean outcome, where riders completing $A_i=1$ pull-ups receive weight $1/\hat{\mathrm{P}}(A_i=1|W_i)$ and riders completing $A_i \ne 1$ pull-ups receive weight 0.

**8. Implement the stabilized IPTW estimator:**
$$ \hat{\theta}_{Stab.IPTW} = \frac{ \frac{1}{n} \sum_{i=1}^n  \frac{\mathrm{I}(A_i=7)}{\hat{\mathrm{P}}(A_i|W_i)} Y_i } {\frac{1}{n} \sum_{i=1}^n  \frac{\mathrm{I}(A_i=7)}{\hat{\mathrm{P}}(A_i|W_i)} } - \frac{ \frac{1}{n} \sum_{i=1}^n  \frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i)} Y_i } { \frac{1}{n} \sum_{i=1}^n  \frac{\mathrm{I}(A_i=1)}{\hat{\mathrm{P}}(A_i|W_i)} } $$
**9. Interpret the point estimates.**



# IPTW & Marginal Structural Models 

In the previous section, we focused on the effect of completing the highest level of pull-ups ($A=7$) and  the lowest level of pull-ups ($A=1$) on happiness. Now suppose we want to smooth over levels of the exposure.  Consider the following MSM to summarize how the expected counterfactual happiness $\mathrm{E}^*(Y_a)$ varies as a function of pull-ups completed $a$: \[
\mathrm{E}^*(Y_a) = m(a | \beta) = \beta_0 + \beta_1 a
\]
with $a \in \{1,2,3,4,5,6,7\}$.  For simplicity, we are treating this MSM as the truth. This specification  assumes a linear change in the expected counterfactual happiness with increasing pull-ups completed. (Alternatively, we can consider this a working MSM and the parameter as the projection of the true causal curve onto this linear model, where all levels of the exposure are weighted evenly.)


## IPTW for the MSM parameter without stabilized weights:

- **Step 1: Estimate the treatment mechanism $\mathrm{P}(A|W)$, which is the conditional probability of completing $A$ pull-ups, given the rider's characteristics.  Use multinomial logistic regression.** *We already did this; skip to the next step.*

- **Step 2: Predict each rider's probability of her observed exposure (pull-ups completed), given his/her covariates $\hat{\mathrm{P}}(A_i|W_i)$.** *We already did this; skip to the next step.*

- **Step 3: Create the  vector `wt` as the inverse of the predicted probabilities.** *We already did this; skip to the next step.*

- **Step 4: Estimate the parameters corresponding to the MSM by regressing the observed outcome $Y$ on the exposure $A$ according to $m(a|\beta)$.** 

**10. Implement step 4. Remember to specify the `weights` and the `data`.**

**11. Interpret the results.**



## IPTW for an MSM parameter with Stabilized Weights

For MSMs without effect modification (e.g. $m(a|\beta)=\beta_0 + \beta_1 a$), a common choice for the numerator of the weights $g^*(A)$ is the marginal probability of the exposure $\mathrm{P}(A=a)$. Therefore, our stabilized weights are \[
stab.wt_i = \frac{\hat{\mathrm{P}}(A)}{\hat{\mathrm{P}}(A|W)}, \text{ where } \hat{\mathrm{P}}(A) = \frac{1}{n}\sum_{i=1}^n \mathrm{I}(A_i=a)
\]
For rare exposures, both the numerator and denominator will be small, leading to less extreme weights and  more efficient estimators.

The  positivity assumption for a parameter defined with a non-saturated MSM  depends on the choice of the numerator: \[
sup_{a \in \mathcal{A}}\  \frac{g^*(a)}{\mathrm{P}(a|w)} < \infty \text{ for all } w  \text{ for which }  \mathrm{P}(W=w)> 0 \]
By choosing the numerator as the marginal probability of each exposure level,  we only need that any value of the exposure occurring with a non-zero probability must also occur with a non-zero probability within all possible strata of the adjustment set $W$. Consequently, the statistical estimand is still defined if some levels of the exposure occur with zero probability.
For instance, in this study there were no riders completing  3.5 pull-ups. By using an MSM, we can smooth over exposure levels.  

Note: If we consider the MSM to be a "working" model, then the choice of the numerator changes the target parameter. (See the Lecture Notes for more details.)


- **Step 1: Estimate the treatment mechanism $\mathrm{P}(A|W)$.** *We already did this; skip to the next step.*

- **Step 2: Predict the probability of the observed exposure for each rider `prob_AW`.** *We already did this; skip to the next step.*

- **Step 3: Create the stabilized weights `wt_MSM`:**
\[
st.wt.i = \frac{\hat{\mathrm{P}}(A)}{\hat{\mathrm{P}}(A|W)}, \text{ where } \hat{\mathrm{P}}(A) = \frac{1}{n}\sum_{i=1}^n \mathrm{I}(A_i=a)
\]

**12. Implement step 3 by doing the following:**

  a) Create empty vector `prob_A` of length $n$ for the numerator of the weights.
  
  b) Index the vector `prob_A` by exposure status and assign the appropriate estimated probability. *Hint:* For riders completing $A=1$ pull-up, the numerator
  $\hat{\mathrm{P}}(A=1)$ is the observed proportion with $A=1$.

```{r, eval=F}
prob_A[ObsData$A==1] <- mean(ObsData$A==1)
# Implement the analogous code for exposure levels A=2,..., A=7
```

  c) Create the stabilized weight:
```{r, eval=F}
wt_MSM <- prob_A/prob_AW
```

**13. Briefly comment on the distribution of the stabilized weights.**

**14. Estimate the parameters corresponding to the MSM by regressing the observed outcome $Y$ and on the exposure $A$.** You must specify the `weights` and the `data`.

# Model comparisons

**15. Are the estimated coefficients the same? Briefly discuss.**

**16. Calculate the robust ("sandwich estimate") standard error of the estimated coefficient and compare to the model-based errors. In what situations should we use the robust standard errors?** *Hint:* Use the `sandwich` library and `vcovHC` function.
