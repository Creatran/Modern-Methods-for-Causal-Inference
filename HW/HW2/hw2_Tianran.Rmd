---
title: "Homework 2"
subtitle: "WCM Modern Methods for Causal Inference"
author: "Tianran Zhang"
date: "June 8, 2020"
output: 
  html_document:
    code_folding: hide
    theme: readable
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggdag)
library(dagitty)
library(ggplot2)
library(pander)

library(locfit)
library(tidyverse)

library(knitr)
library(kableExtra)
```
## Step 0: Scientific question:

Suppose we are interesting in evaluating the effect of this integrated approach on all-cause childhood mortality in the greater Sahel region.  Let $W_1$ be an indicator of the child's access to health care facilities. Let $W_2$ be an indicator, equaling 1 if the child lives conflict area.  The intervention $A$ is also an indicator, equaling 1 if the child subsequently received prevention package and equaling 0 if the child received the standard of care. Finally, the outcome $Y$ represents the child's survival status at the end of two years. 

## Step 1: Causal model representing real knowledge:

Suppose this **simplified** study can be translated into the following structural causal model (SCM):

  - Endogenous nodes: $X =(W_1, W_2, A, Y)$ 
  
  - Background (exogenous) variables: $U=(U_{W_1},U_{W_2},U_{A},U_{Y})\sim \mathrm{P}^*$ 
  
  - Structural equations $F$:  
  
\begin{align*}
W_1& \leftarrow f_{W_1}(U_{W_1})\\
W_2& \leftarrow f_{W_2}(U_{W_2})\\
A& \leftarrow f_A(W_1, W_2, U_A)\\
Y& \leftarrow f_{Y}(W_1,W_2, A, U_{Y})
\end{align*}


## Step 2: Counterfactuals & causal parameter:

The target causal parameter is the difference in the counterfactual probability of survival if all children  received the combination prevention package and the counterfactual probability of survival if all children did not receive the package:

\[\theta^*  = \mathrm{E}^*(Y_1) - \mathrm{E}^*(Y_0) = \mathrm{P}^*(Y_1 = 1) - \mathrm{P}^*(Y_0 = 1) \]

# Roadmap  Questions

## Step 3: Observed data \& link to causal:

Suppose the observed data consist of $n$ independent, identically distributed (i.i.d) draws of the random variable $O=(W_1,W_2, A, Y)$.
  
  1. **Specify the link between the SCM and the observed data.**    
  $O=(W_1,W_2, A, Y) \sim P$: The observed data are a (multidimensional) random variable with distribution P. We observe a sample of size n of random variable O. This gives us n independent identically distribution (i.i.d.) copies of $O_1, O_2, ..., O_n$ drawn from probability distribution P.    
  We assume that the observed data were generated by a system compatible with our structural causal model. The distribution of the background variables P* and the structural equations F identify the distribution of the observed data.  
  Since we knew the distribution of U and the functions F, we would know the distribution of O. Thus, the causal model has implications for the distribution of O. These implications are testable.  
  

  2. **What restrictions, if any, does the SCM place on the set of     allowed distributions for the observed data?**     
  Exclusion restrictions: the strutural equations F implies $W_1 \not \in Pa(W_2)$, $W_1 \perp \!\!\! \perp W_2$.     
  Statistical model: all probability distributions satisfying $W_1 \perp \!\!\! \perp W_2$. 
  The restrictions this causal model puts on the set of allowed distributions for the observed data: $W_1$ is independent of $W_2$.  
  
  3. **What notation do we use to denote the true (but unknown) distribution of the observed data and the statistical model?**    
  We use P to denote the true (but unknown) distributions for the observed data: $O=(W_1,W_2, A, Y)$, $O_1, O_2, ..., O_n \ \  iid \sim P$     
  The statistical model is the set of possible distributions for the observed data, that is all functions p(x) such that p(x) > 0 and $\int p(x)dx = 1$. We use P\* to denote the distribution of the counterfactual random variables $(Y_1, Y_0) \sim P^*$.         
  

## Step 4-5: Identification & statistical estimand:
  4. **Using the backdoor criterion, assess identifiability.**     
  Graphical model:   
```{r}
dag <- dagify(Y ~ W1 + W2 + A + UY,
                A ~ W1 + W2 + UA,
                W2 ~ UW2,
                W1 ~ UW1,
                exposure = "A",
                outcome = "Y")
tidy_dag <- tidy_dagitty(dag)

ggdag(tidy_dag, layout = "circle")
```
  
  Backdoor criterion: A set of variables W satisﬁes the back-door criterion with respect to the effect of A on Y if: 1) No node in W is a descendant of A. 2) W blocks all “back-door" paths from A to Y.    
There is not any subset of observed covariates that satisﬁes the back-door criterion since there might be some unmeasured common causes among $U_A, U_{W1}, U_{W2}, U_Y$.       
  
  5. **If the target causal parameter is not identified, under what assumptions would it be?**        
  If $U_A \perp \!\!\! \perp U_{U_Y}$, and ($U_A \perp \!\!\! \perp U_{W1}$, or $U_Y \perp \!\!\! \perp U_{W1}$), and ($U_A \perp \!\!\! \perp W_2$, or $U_Y \perp \!\!\! \perp U_{W2}$), then \{W1, W2\} would satisfy the back-door criterion with respect to the effect of A on Y since a). Neither w1 nor w2 is a descendant of A; b). W1 and W2 blocks all "back-door" paths from A to Y.    
Thus, under the above independence assumptions, conditional on covariates \{W1, W2\}, any observed association between A and Y is due to the effect of the exposure A on the outcome Y.
  
  
  6. **What notation is used to denote the original SCM augmented with additional assumptions needed for identifiability?**     
  Original SCM:   
  
  - Endogenous nodes: $X =(W_1, W_2, A, Y)$ 
  
  - Background (exogenous) variables: $U=(U_{W_1},U_{W_2},U_{A},U_{Y})\sim \mathrm{P}^*$ 
  
  - Structural equations $F$:  
  
\begin{align*}
W_1& \leftarrow f_{W_1}(U_{W_1})\\
W_2& \leftarrow f_{W_2}(U_{W_2})\\
A& \leftarrow f_A(W_1, W_2, U_A)\\
Y& \leftarrow f_{Y}(W_1,W_2, A, U_{Y})
\end{align*}
  
  Additional assumptions needed for identifiability:   
   $U_A \perp \!\!\! \perp U_{U_Y}$, and ($U_A \perp \!\!\! \perp U_{W1}$, or $U_Y \perp \!\!\! \perp U_{W1}$), and ($U_A \perp \!\!\! \perp W_2$, or $U_Y \perp \!\!\! \perp U_{W2}$)     
  
  
  7. **Specify the target parameter of the observed data distribution (the statistical estimand).**      

$$ \begin{align}
\theta &= E[E[Y|A = 1, W_1, W_2] - E[Y|A = 0, W_1, W_2]]\\
&= \sum_{w_1, w_2}[E[Y|A = 1, w_1, w_2] - E[Y|A = 0, w_1, w_2]]p(w_1, w_2)
\end{align}
$$
  

  8. **What is the relevant positivity assumption? Is it reasonable here?**     
  Here to identify E\*(Ya) using the G-computation formula, we need E(Y |A = a, W1 = w1, W2 = w2) to be well-deﬁned for all possible values the exposure and covariates (a, w1, w2). Which means that in a non-parametric statistical model, each exposure of interest must occur with some possible probability for each possible covariate history.   
  Positivity assumption in formula:   
  $min_{a \in \{0, 1\}}P(A = a|W1 = w1, W2 = w2) > 0$ for all w1, w2 for which P(W1 = w1) > 0, P(W2 = w2) > 0.     
  It is not reasonable here since in the two-year programme, the organization gave all children antimalarial tablets - whether or not they had the disease - during the four-month malaria season. That is $P(A = 0|W1 = w1, W2 = w2) = 0$ for all w1, w2.   


# A specific data generating process      

Consider a specific data generating process (unknown to the researchers), which is one of many compatible with the SCM. The endogenous factors $U$ are independently generated as:

\begin{align*}
U_{W_1} &\sim Uniform(0,1) \\
U_{W_2}& \sim Uniform(0,1) \\
U_A &\sim Uniform(0, 1) \\
U_Y &\sim Uniform(0, 1)
\end{align*}

Given the background/exogenous $U$, the endogenous variables are deterministically generated as:

 \begin{align*}
W_1& \leftarrow \mathrm{I}[U_{W_1}< 0.50]\\
W_2& \leftarrow \mathrm{I}[U_{W_2}< 0.50]\\
A& \leftarrow \mathrm{I}[U_A< expit(-0.5 + W_1 - 1.5^*W_2)]\\
Y&\leftarrow \mathrm{I}[U_Y < expit(-0.75 + W_1 - 2^*W_2 + 2.5^*A +A^*W_1 )]
\end{align*}

9. **Evaluate the postivity assumption in closed form for this data generating process.**       
$P(A = a|W1 = w1, W2 = w2) \ge 0$ for all possible w1, w2.    
  Specifically:       
$P(A = 1|W1 = 1, W2 = 0) = expit(-0.5 + 1 - 1.5 * 0)$ = `r expit(-0.5 + 1 - 1.5 * 0)` >0          
$P(A = 1|W1 = 1, W2 = 1) = expit(-0.5 + 1 - 1.5 * 1)$ = `r expit(-0.5 + 1 - 1.5 * 1)` >0           
$P(A = 1|W1 = 0, W2 = 0) = expit(-0.5 + 0 - 1.5 * 0)$ = `r expit(-0.5 + 0 - 1.5 * 0)` >0             
$P(A = 1|W1 = 0, W2 = 1)  = expit(-0.5 + 0 - 1.5 * 1)$ = `r expit(-0.5 + 0 - 1.5 * 1)` >0   
Since $P(A = 1|W_1, W_2)$ are all greater than 0 and less than 1 for all w1, w2, $P(A = 0|W_1, W_2)$ are all greater than 0. Thus the positive assumption is not violated.     
  In this particular data generating system (one of many compatible with the SCM), the conditional probability of receiving the intervention given the baseline covariates is \[
\mathrm{P}(A=1 | W_1, W_2) = expit(-0.5 + W_1 - 1.5^*W_2)
\]

10. **Evaluate the statistical estimand $\theta$ in closed form for this data generating process.**       

```{r}
theta <- (expit(-0.75+1-2*1+2.5*1+1*1)-expit(-0.75+1-2*1+2.5*0+0*1))*0.5*0.5+
(expit(-0.75+1-2*0+2.5*1+1*1)-expit(-0.75+1-2*0+2.5*0+0*1))*0.5*0.5+
(expit(-0.75+0-2*1+2.5*1+1*0)-expit(-0.75+0-2*1+2.5*0+0*0))*0.5*0.5+
(expit(-0.75+0-2*0+2.5*1+1*0)-expit(-0.75+0-2*0+2.5*0+0*0))*0.5*0.5
```

$$ \begin{align}
\theta &= E[E[Y|A = 1, W_1, W_2] - E[Y|A = 0, W_1, W_2]]\\
&= \sum_{w_1, w_2}[P[Y|A = 1, w_1, w_2] - E[P|A = 0, w_1, w_2]]p(w_1, w_2)\\
&= [P[Y|A = 1, W_1 = 1, W_2 = 1] - P[Y|A = 0, W_1 = 1, W_2 = 1]]p(W_1 = 1, W_2 = 1)  \\
&+ [P[Y|A = 1, W_1 = 1, W_2 = 0] - P[Y|A = 0, W_1 = 1, W_2 = 0]]p(W_1 = 1, W_2 = 0)  \\
&+ [P[Y|A = 1, W_1 = 0, W_2 = 1] - P[Y|A = 0, W_1 = 0, W_2 = 1]]p(W_1 = 0, W_2 = 1)  \\
&+ [P[Y|A = 1, W_1 = 0, W_2 = 0] - P[Y|A = 0, W_1 = 0, W_2 = 0]]p(W_1 = 0, W_2 = 0) \\
&= 0.507
\end{align}
$$

11. **Translate this data generating process into simulations.**

  a. First set the seed to 252.
  b. Suppose our target population consists of 100,000 people. Set the number of draws $n=100,000$.
  c. Sample $n$ i.i.d. observations of random variable $O=(W_1,W_2,A,Y) \sim \mathrm{P}$.
  d. Intervene to set the exposure to the combination package ($A=1$) and generate the counterfactual outcome $Y_1$. Intervene to set the exposure to the standard of care ($A=0$) and generate the counterfactual outcomes $Y_0$.
  e. Evaluate the causal parameter $\theta^*$.

```{r}
set.seed(252)
n <- 100000
UW1 <- runif(n, 0, 1)
UW2 <- runif(n, 0, 1)
UA <- runif(n, 0, 1)
UY <- runif(n, 0, 1)

W1 <- ifelse(UW1 < 0.5, 1, 0)
W2 <- ifelse(UW2 < 0.5, 1, 0)
A <- ifelse(UA < expit(-0.5 + W1 - 1.5 * W2), 1, 0)
Y <- ifelse(UY < expit(-0.75 + W1 - 2 * W2 + 2.5 * A + A * W1), 1, 0)

Y1 <- ifelse(UY < expit(-0.75 + W1 - 2 * W2 + 2.5 * 1 + 1 * W1), 1, 0)
Y0 <- ifelse(UY < expit(-0.75 + W1 - 2 * W2 + 2.5 * 0 + 0 * W1), 1, 0)

theta.star <- mean(Y1) - mean(Y0)
```

The causal parameter $\theta^*$ is `r theta.star %>% round(3)`. 

12. **Evaluate the positivity assumption by take the mean of the exposure $A$ in each strata of covariates $(W_1,W_2)$. Are there positivity violations?**    

```{r}
dat <- data.frame(W1, W2, A, Y)
dat %>%
  group_by(W1, W2) %>%
  summarise(`P(A|W1, W2)` = mean(A), .groups = "drop") %>%
  kable() %>%
  kable_styling()
```
  It seems there is no violation of the positivity since the mean of the exposure $A$ in each strata of covariates $(W_1,W_2)$ is positive. 



13. **Evaluate the statistical estimand $\theta$.**     
```{r}
theta <- dat %>%
  group_by(A, W1, W2) %>%
  summarise(ya = mean(Y), n = n(), .groups = "drop") %>%
  group_by(W1, W2) %>%
  summarise(ya = diff(ya),n = sum(n), .groups = "drop") %>%
  mutate(theta = sum(ya * n/nrow(dat))) %>%
  pull(theta) %>%
  head(1)

```
  The statistical estimand $\theta$ is: `r theta %>% round(3)`.   

14. **Interpret $\theta$.**     
  $\theta$ is the expected difference of child’s survival rate at the end of two years between the child who received prevention package and the child received the standard of care. $\theta = $ `r theta %>% round(3)` means that children who subsequently received prevention package have a `r theta %>% round(3)` higher survival rate compared to those received the standard of care.    




